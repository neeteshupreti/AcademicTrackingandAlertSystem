{% extends 'core/admin_base.html' %}
{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-md-3">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-dark text-white fw-bold">Import Methods</div>
                <div class="list-group list-group-flush">
                    <a href="{% url 'import_records' %}" class="list-group-item list-group-item-action active">
                        <i class="bi bi-image-fill me-2"></i> Image OCR (KU Sheet)
                    </a>
                    <a href="{% url 'upload_gpa' %}" class="list-group-item list-group-item-action">
                        <i class="bi bi-file-earmark-spreadsheet-fill me-2"></i> GPA Sheet (CSV/Excel)
                    </a>
                </div>
            </div>
            
            <div class="alert alert-info border-0 shadow-sm" style="font-size: 0.85rem;">
                <i class="bi bi-info-circle-fill me-1"></i> 
                <strong>Tip:</strong> For best results, use the <b>Upload Image</b> option with a high-resolution photo of the transcript.
            </div>
        </div>

        <div class="col-md-9">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white p-3">
                    <h5 class="mb-0"><i class="bi bi-scan me-2"></i> Transcript Data Extraction</h5>
                </div>
                
                <div class="card-body p-4">
                    <div class="d-flex justify-content-center mb-4">
                        <div class="btn-group shadow-sm" role="group">
                            <button type="button" onclick="switchInput('file')" class="btn btn-outline-primary px-4 active" id="btn-file">
                                <i class="bi bi-cloud-upload me-1"></i> 1. Upload Image
                            </button>
                            <button type="button" onclick="switchInput('cam')" class="btn btn-outline-primary px-4" id="btn-cam">
                                <i class="bi bi-camera me-1"></i> 2. Use Camera
                            </button>
                        </div>
                    </div>

                    <div id="file-section" class="py-5 border-dashed rounded bg-light text-center mb-3" style="border: 2px dashed #dee2e6;">
                        <i class="bi bi-file-earmark-image display-4 text-muted"></i>
                        <p class="mt-3 text-secondary fw-bold">Select KU Academic Record Photo</p>
                        <input type="file" id="filePicker" class="form-control w-50 mx-auto" accept="image/*" onchange="uploadImage(event)">
                    </div>

                    <div id="cam-section" class="d-none text-center">
                        <div class="position-relative d-inline-block w-100 bg-dark rounded overflow-hidden shadow-sm" style="height: 400px;">
                            <video id="webcam" autoplay playsinline class="w-100 h-100" style="object-fit: cover;"></video>
                        </div>
                        <button onclick="takePhoto()" class="btn btn-danger btn-lg w-100 mt-3 fw-bold shadow">CAPTURE & ANALYZE</button>
                    </div>

                    <canvas id="bufferCanvas" class="d-none"></canvas>

                    <div id="processing" class="d-none text-center my-5">
                        <div class="spinner-grow text-primary" role="status"></div>
                        <p class="mt-3 fw-bold text-primary">ATAS Engine Analyzing Document...</p>
                    </div>

                    <div id="results-card" class="d-none mt-4 p-4 border rounded-3 bg-white shadow-sm border-start border-5 border-primary">
                        <h6 class="text-uppercase text-muted fw-bold mb-3">Verification Dashboard</h6>
                        
                        <div class="form-floating mb-3">
                            <input type="text" id="res-name" class="form-control fw-bold border-primary" placeholder="Name">
                            <label><i class="bi bi-person"></i> STUDENT NAME</label>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-floating mb-3">
                                    <input type="text" id="res-gpa" class="form-control" placeholder="GPA">
                                    <label>GPA</label>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="form-floating mb-3">
                                    <input type="text" id="res-failed" class="form-control text-danger fw-bold" placeholder="Failed Subjects">
                                    <label>FAILED SUBJECTS (BACKLOGS)</label>
                                </div>
                            </div>
                        </div>
                        <button onclick="commitToSystem()" class="btn btn-success w-100 py-2 fw-bold shadow-sm mt-2">CONFIRM & RECORD DATA</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const video = document.getElementById('webcam');
    const canvas = document.getElementById('bufferCanvas');
    let stream = null;
    let isFailing = false;

    function switchInput(mode) {
        document.getElementById('file-section').classList.toggle('d-none', mode !== 'file');
        document.getElementById('cam-section').classList.toggle('d-none', mode !== 'cam');
        document.getElementById('btn-file').classList.toggle('active', mode === 'file');
        document.getElementById('btn-cam').classList.toggle('active', mode === 'cam');
        
        if(mode === 'cam') {
            startWebcam();
        } else {
            stopWebcam();
        }
    }

    async function startWebcam() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: 1280, height: 720 } 
            });
            video.srcObject = stream;
        } catch (err) {
            alert("Could not access camera: " + err.message);
        }
    }

    function stopWebcam() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            video.srcObject = null;
        }
    }

    function uploadImage(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => processImage(reader.result);
        reader.readAsDataURL(file);
    }

    function takePhoto() {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        processImage(canvas.toDataURL('image/jpeg', 0.9));
    }

    async function processImage(base64Data) {
        document.getElementById('processing').classList.remove('d-none');
        document.getElementById('results-card').classList.add('d-none');

        const response = await fetch('/students/process-scan/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify({ image: base64Data })
        });
        const data = await response.json();

        document.getElementById('processing').classList.add('d-none');
        
        if (data.status === 'success') {
            document.getElementById('results-card').classList.remove('d-none');
            document.getElementById('res-name').value = data.extracted_data.name;
            document.getElementById('res-gpa').value = data.extracted_data.gpa;
            document.getElementById('res-failed').value = data.extracted_data.failed_subjects;
            isFailing = data.is_failing;
        }
    }

    async function commitToSystem() {
        const payload = {
            name: document.getElementById('res-name').value,
            gpa: document.getElementById('res-gpa').value,
            failed_subjects: document.getElementById('res-failed').value,
            is_failing: isFailing
        };
        
        const response = await fetch('/students/save-verified/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify(payload)
        });
        const result = await response.json();
        if(result.status === 'success') {
            alert("Sync Complete: Record for " + payload.name + " saved.");
            location.reload();
        }
    }
</script>

<style>
    .border-dashed { border-style: dashed !important; }
    .btn-group .btn { transition: all 0.2s; }
</style>
{% endblock %}